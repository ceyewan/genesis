# CLAUDE.md

此文件用于约束 Claude Code (claude.ai/code) 在 `Genesis` 仓库中的工作方式。请全程使用中文交流与记录，遵守下述行为准则，并对自己负责。

## 项目概览

`Genesis` 是一个 Go 语言微服务基座项目，旨在沉淀可复用的基础设施组件。仓库采用单一 `go.mod`，通过 `pkg/` 定义抽象接口，在 `internal/` 提供默认实现，并计划使用 `go.uber.org/fx` 完成依赖注入和生命周期管理。

## 行为准则（编程版八荣八耻）
1. **以凭空猜测为耻，以查阅文档为荣**：对接口、配置、流程有疑问时，先读 `docs/`、`pkg/` 源码与注释。
2. **以模糊执行为耻，以确认反馈为荣**：不确定的改动先询问或验证，避免“差不多”式修改。
3. **以自说自话为耻，以对齐需求为荣**：实现前确认需求背景与边界，必要时向人类说明假设。
4. **以重复造轮为耻，以复用抽象为荣**：优先复用 `pkg/` 接口和已存在的工具，避免新增无用抽象。
5. **以跳过验证为耻，以主动测试为荣**：改动后运行对应的测试或静态检查，确保功能与行为稳定。
6. **以破坏架构为耻，以遵循规范为荣**：保持 `pkg` 暴露接口、`internal` 隐藏实现的结构，不将第三方依赖泄漏到 `pkg`。
7. **以假装理解为耻，以诚实求助为荣**：遇到不懂的概念或代码路径，坦诚指出并寻找答案。
8. **以鲁莽提交为耻，以谨慎重构为荣**：重构前先理解上下游调用，必要时分步骤进行并记录风险。

## 目录速览
```
.
├── cmd/            # 应用入口（fx 应用将驻留于此）
├── configs/        # 默认配置样例
├── docs/           # 设计、组件、使用手册
├── internal/       # 具体实现与适配器
└── pkg/            # 对外公开的接口契约
```

## 设计原则
- **抽象优先**：业务与外部调用方仅依赖 `pkg` 中的接口；实现细节封装在 `internal`。
- **插件化实现**：同一接口可有多种实现（如 `internal/cache/redis`），方便替换与扩展。
- **依赖注入**：统一通过 `fx.Module` 或构造函数注入依赖，保持生命周期受控。
- **可观测性优先**：日志、指标、追踪是默认能力，组件开发需同步考虑。
- **简洁交付**：默认配置可直接运行；复杂能力通过选项按需启用。

## 推荐工作流
1. **学习顺序**：阅读 `DESIGN.md` → `docs/usage_guide.md` → 目标组件文档。
2. **新增能力**：参考 `docs/module_creation_guide.md` 完成接口定义、实现、测试与文档。
3. **依赖安装**：使用 `go mod tidy` 管理依赖；新增第三方库前确认必要性。
4. **运行与测试**：
   ```bash
   go test ./...
   go run ./cmd/server
   ```
   后续如引入 Makefile，再使用统一命令。
5. **文档同步**：接口或行为变化必须同步更新 `docs/` 与相关样例配置。

## 代码守则
- 所有 I/O 操作接受 `context.Context`，并通过日志记录携带 trace/请求信息。
- 错误处理使用 `fmt.Errorf("...: %w", err)` 或 `errors.Join`，保持信息链完整。
- 新增包需提供简要 `doc.go` 注释，帮助快速了解职责。
- `gofmt`、`go vet`、`staticcheck` 通过后再交付结果。

## 常见场景提示
- **配置加载**：由 `config` 组件集中管理，避免在业务代码直接解析文件。
- **数据库事务**：使用 `db.Transaction.ExecTx` 包裹事务逻辑，避免嵌套事务导致死锁。
- **缓存幂等**：结合 `cache` 与 `middleware/once`，防止重复请求造成副作用。
- **服务治理**：`middleware/ratelimit`、`middleware/breaker`、`middleware/once` 提供统一治理能力，保持业务代码纯净。

## 绝对禁止
- 直接向仓库提交明文密钥或凭证。
- 擅自改动用户未交待的历史文件，除非修复因本次改动引发的问题。
- 使用英文与用户或日志交互（除代码与 Go 保留字外）。

遵守上述规范，可确保在 Genesis 项目中高效、安全地迭代。
