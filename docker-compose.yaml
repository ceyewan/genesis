# ================================================================================
# Genesis 核心基础设施
# 包含运行应用所必需的服务: etcd, kafka, mysql, redis
# ================================================================================

# 通用配置模板（Extension Fields）
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-restart-policy: &default-restart
  restart: unless-stopped

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 40s

# etcd 通用配置
x-etcd-common: &etcd-common
  image: quay.io/coreos/etcd:v3.5.12
  <<: *default-restart
  logging: *default-logging
  networks:
    - genesis-net
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD", "etcdctl", "endpoint", "health"]

# kafka 通用配置
x-kafka-common: &kafka-common
  image: apache/kafka:3.7.0
  <<: *default-restart
  logging: *default-logging
  networks:
    - genesis-net
  healthcheck:
    <<: *healthcheck-defaults
    test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092"]
  deploy:
    resources:
      limits:
        memory: 2G
      reservations:
        memory: 512M
  environment: &kafka-base-env
    KAFKA_PROCESS_ROLES: controller,broker
    KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka1:9093,2@kafka2:9093,3@kafka3:9093
    KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
    KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
    KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
    KAFKA_CLUSTER_ID: MkQkQ2QxNTcwNDJhMzQ1NQ
    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 3
    KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 3
    KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 2
    KAFKA_DEFAULT_REPLICATION_FACTOR: 3
    KAFKA_MIN_INSYNC_REPLICAS: 2

networks:
  genesis-net:
    driver: bridge
    name: genesis-net

volumes:
  etcd-data-1:
  etcd-data-2:
  etcd-data-3:
  kafka-data-1:
  kafka-data-2:
  kafka-data-3:
  mysql-data:
  redis-data:

services:
  # ===== etcd 集群 =====
  etcd1:
    <<: *etcd-common
    container_name: genesis-etcd1
    hostname: etcd1
    environment:
      ETCD_NAME: etcd1
      ETCD_INITIAL_CLUSTER_TOKEN: genesis-etcd-cluster
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_INITIAL_CLUSTER: etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd1:2380
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd1:2379
    ports:
      - "2379:2379"
    volumes:
      - etcd-data-1:/etcd-data

  etcd2:
    <<: *etcd-common
    container_name: genesis-etcd2
    hostname: etcd2
    environment:
      ETCD_NAME: etcd2
      ETCD_INITIAL_CLUSTER_TOKEN: genesis-etcd-cluster
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_INITIAL_CLUSTER: etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd2:2380
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd2:2379
    volumes:
      - etcd-data-2:/etcd-data

  etcd3:
    <<: *etcd-common
    container_name: genesis-etcd3
    hostname: etcd3
    environment:
      ETCD_NAME: etcd3
      ETCD_INITIAL_CLUSTER_TOKEN: genesis-etcd-cluster
      ETCD_INITIAL_CLUSTER_STATE: new
      ETCD_INITIAL_CLUSTER: etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd3:2380
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd3:2379
    volumes:
      - etcd-data-3:/etcd-data

  # ===== MySQL 数据库 =====
  mysql:
    image: mysql:8.0.36
    container_name: genesis-mysql
    hostname: mysql
    <<: *default-restart
    logging: *default-logging
    environment:
      MYSQL_ROOT_PASSWORD: genesis_root_2024
      MYSQL_DATABASE: genesis_dev
      MYSQL_USER: genesis
      MYSQL_PASSWORD: genesis_pass_2024
      TZ: Asia/Shanghai
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=caching_sha2_password
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - genesis-net
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]

  # ===== Redis 缓存 =====
  redis:
    image: redis:7.2.4-alpine
    container_name: genesis-redis
    hostname: redis
    <<: *default-restart
    logging: *default-logging
    command: 
      - redis-server
      - --appendonly yes
      - --requirepass genesis_redis_2024
      - --maxmemory 512mb
      - --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - genesis-net
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]

  # ===== Kafka 集群 (KRaft 模式) =====
  kafka1:
    <<: *kafka-common
    container_name: genesis-kafka1
    hostname: kafka1
    environment:
      <<: *kafka-base-env
      KAFKA_NODE_ID: 1
      KAFKA_LISTENERS: INTERNAL://:9092,EXTERNAL://:19092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka1:9092,EXTERNAL://localhost:19092
    ports:
      - "19092:19092"
    volumes:
      - kafka-data-1:/var/lib/kafka/data

  kafka2:
    <<: *kafka-common
    container_name: genesis-kafka2
    hostname: kafka2
    environment:
      <<: *kafka-base-env
      KAFKA_NODE_ID: 2
      KAFKA_LISTENERS: INTERNAL://:9092,EXTERNAL://:29092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka2:9092,EXTERNAL://localhost:29092
    ports:
      - "29092:29092"
    volumes:
      - kafka-data-2:/var/lib/kafka/data

  kafka3:
    <<: *kafka-common
    container_name: genesis-kafka3
    hostname: kafka3
    environment:
      <<: *kafka-base-env
      KAFKA_NODE_ID: 3
      KAFKA_LISTENERS: INTERNAL://:9092,EXTERNAL://:39092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka3:9092,EXTERNAL://localhost:39092
    ports:
      - "39092:39092"
    volumes:
      - kafka-data-3:/var/lib/kafka/data
