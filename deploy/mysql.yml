# ====================================================================================
# MySQL 8.0 配置文件
# ====================================================================================
# 描述: 用于开发和测试环境的MySQL数据库服务
# 网络: 使用 genesis-net 网络，与基础设施服务通信
# 存储: 使用Docker卷进行数据持久化
# 访问: 仅暴露客户端端口3306到宿主机，限制为127.0.0.1访问
# 特点: 优化的内存配置，UTF8MB4字符集，性能调优
# 用途: 为应用程序提供关系型数据库服务
# ====================================================================================

services:
  # ===== MySQL 数据库服务 =====
  mysql:
    # 使用官方MySQL 8.0镜像，稳定且功能完整
    image: mysql:8.0
    
    # 容器名称，便于识别和管理
    container_name: genesis-mysql
    
    # 主机名，用于网络内部通信和服务发现
    hostname: mysql
    
    # 重启策略：除非手动停止，否则总是自动重启
    restart: unless-stopped
    
    # 环境变量配置：数据库初始化参数
    environment:
      # MySQL root用户密码，从环境变量读取，确保安全性
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      
      # 默认创建的数据库名称，从环境变量读取
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      
      # 默认创建的普通用户，从环境变量读取
      MYSQL_USER: ${MYSQL_USER}
      
      # 普通用户的密码，从环境变量读取
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    
    # 启动命令：MySQL服务器启动参数优化
    command:
      # MySQL服务器可执行文件
      - mysqld
      
      # 禁用性能模式：减少内存占用，适合开发环境
      - --performance_schema=OFF
      
      # InnoDB缓冲池大小：设置为256MB，适合容器环境
      # 缓冲池用于缓存数据和索引，影响查询性能
      - --innodb_buffer_pool_size=256M
      
      # 最大连接数：限制为50个，防止资源耗尽
      - --max_connections=50
      
      # 字符集设置：使用utf8mb4，支持完整的Unicode字符
      - --character-set-server=utf8mb4
      
      # 排序规则：使用utf8mb4_unicode_ci，更好的Unicode排序
      - --collation-server=utf8mb4_unicode_ci
    
    # 数据卷配置：数据持久化存储
    volumes:
      # 使用Docker卷便于备份和迁移，与宿主机解耦
      # 存储数据库文件、表结构、索引等所有数据
      - mysql-data:/var/lib/mysql
    
    # 网络配置：加入基础设施网络
    networks:
      - genesis-net
    
    # 资源限制：防止资源耗尽影响宿主机
    deploy:
      resources:
        limits:
          memory: 768M  # 最大内存限制，防止内存泄漏
        reservations:
          memory: 512M  # 最小内存预留，确保基本运行
    
    # 日志配置：限制日志大小，防止磁盘空间耗尽
    logging:
      driver: json-file
      options:
        max-size: "5m"  # 单个日志文件最大5MB
        max-file: "2"   # 保留2个日志文件，循环使用
    
    # 端口映射：仅暴露客户端端口，限制为本地访问
    ports:
      - "127.0.0.1:3306:3306"  # 仅本地访问，提高安全性

# ====================================================================================
# 网络和存储配置
# ====================================================================================

# 网络定义：使用外部已创建的genesis-net网络
networks:
  genesis-net:
    external: true
    # 说明：genesis-net是基础设施网络，所有基础服务都在此网络中
    # 用途：为MySQL与其他服务（如new-api）通信提供网络
    # 创建命令：docker network create genesis-net

# 存储卷定义：数据持久化存储
volumes:
  mysql-data:
    # 说明：MySQL数据卷，存储所有数据库文件和配置
    # 优点：与宿主机解耦，便于备份和容器迁移
    # 管理：docker volume ls / docker volume inspect mysql-data
    # 注意：包含所有数据库数据，重要数据请定期备份

# ====================================================================================
# 使用说明和运维指南
# ====================================================================================
# 启动服务:
#   docker compose -f mysql.yml up -d
#
# 查看状态:
#   docker compose -f mysql.yml ps
#
# 查看日志:
#   docker compose -f mysql.yml logs -f
#
# 连接数据库:
#   docker exec -it genesis-mysql mysql -uroot -p
#   # 输入MYSQL_ROOT_PASSWORD环境变量中的密码
#
# 创建数据库备份:
#   docker exec genesis-mysql mysqldump -uroot -p${MYSQL_ROOT_PASSWORD} ${MYSQL_DATABASE} > backup.sql
#
# 恢复数据库:
#   docker exec -i genesis-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} ${MYSQL_DATABASE} < backup.sql
#
# 查看数据库大小:
#   docker exec genesis-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT table_schema AS 'Database', SUM(data_length + index_length) / 1024 / 1024 AS 'Size (MB)' FROM information_schema.tables GROUP BY table_schema;"
#
# 性能监控:
#   docker exec genesis-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SHOW PROCESSLIST;"
#   docker exec genesis-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SHOW STATUS LIKE 'Threads%';"
#
# 停止服务:
#   docker compose -f mysql.yml down
#
# 数据备份:
#   # MySQL数据存储在卷中，可以通过卷备份
#   docker run --rm -v mysql-data:/var/lib/mysql -v $(pwd):/backup alpine tar czf /backup/mysql-data-backup.tar.gz /var/lib/mysql
#
# 性能调优建议:
#   - 根据实际负载调整innodb_buffer_pool_size（建议为总内存的60-80%）
#   - 监控连接数使用情况，必要时调整max_connections
#   - 定期分析和优化表：ANALYZE TABLE 和 OPTIMIZE TABLE
#   - 设置合适的日志保留策略，避免日志文件过大
#   - 生产环境建议启用慢查询日志
# ====================================================================================