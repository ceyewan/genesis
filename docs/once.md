# Once 组件实施手册

## 功能边界
- 提供幂等控制能力，保障同一业务操作只执行一次。
- 依赖缓存或协调器记录操作状态，可扩展存储后端。
- 支持处理并发冲突与超时后的自动恢复。

## 代码位置
- 接口：`pkg/middleware/once.go`
- 默认实现：`internal/middleware/once`
- 辅助存储：默认复用 `cache` 组件。

## 开发步骤
1. **接口设计**：
   - 定义 `Executor`、`ResultStore` 等抽象。
   - 支持 `Do(ctx, key, fn)` 与带返回值的 `DoValue`。
2. **状态记录**：使用缓存记录执行状态（进行中、成功、失败）。
3. **过期控制**：配置可调 TTL，避免死锁；执行失败需删除状态。
4. **回调封装**：在执行函数内捕获错误和 panic，确保状态落地。
5. **DI 集成**：通过 `fx` 注入缓存依赖，支持自定义存储。

## 测试要点
- 单测：并发发起同一 key 的请求，只执行一次。
- 集成：结合缓存组件，验证失效后可重新执行。
- 观测：记录幂等命中率、执行耗时、失败统计。

## 验收清单
- 状态键包含环境与业务前缀，避免冲突。
- 支持幂等键自定义生成策略。
- 在 `usage_guide.md` 提供 HTTP 幂等示例。

## 后续演进
- 提供基于数据库的实现，适用于事务性场景。
- 引入事件记录，用于审计和回溯。
