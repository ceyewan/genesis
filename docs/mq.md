# MQ 组件实施手册

## 功能边界
- 提供统一的消息生产、消费接口，支持批量与顺序消费。
- 默认实现对接 Kafka，可拓展至 RabbitMQ、Pulsar。
- 支持重试、死信、消息追踪。

## 代码位置
- 接口：`pkg/mq/mq.go`
- 配置：`pkg/mq/config.go`
- 默认实现：`internal/mq/kafka`
- 重试工具：`internal/mq/kafka/retry.go`

## 开发步骤
1. **接口划分**：发布者、消费者、消息结构、消费组管理。
2. **配置**：brokers、topic、分区策略、重试次数、死信 Topic。
3. **Kafka 封装**：
   - 使用 `segmentio/kafka-go` 或 `sarama`，提供同步/异步发送。
   - 消费端支持自动提交与手动提交 offset。
4. **诊断能力**：记录消息延迟、失败次数，关联 trace。
5. **DI Module**：根据配置生成复用或独立客户端，在 `fx` 中注册。

## 测试要点
- 单测：消息编码/解码、重试策略、错误分类。
- 集成：使用 docker-compose 启动 Kafka，验证生产/消费链路。
- 可靠性：模拟网络中断，确认重连与重试策略生效。

## 验收清单
- 支持幂等生产者（附加消息键）。
- 消费端可配置并发度与批大小。
- 异常路径有日志与指标支撑定位。

## 后续演进
- 引入事务消息支持。
- 整合 dead-letter 队列的自动清理与告警。
