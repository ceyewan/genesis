# Coord 组件实施手册

## 功能边界
- 基于 etcd 提供分布式协调：租约、锁、配置订阅、选主。
- 为 `uid`、`config` 等组件提供基础能力。
- 支持多租户命名空间隔离。

## 代码位置
- 接口：`pkg/coord/coord.go`
- 默认实现：`internal/coord/etcd`
- 工具函数：`internal/coord/etcd/internal`

## 开发步骤
1. **接口梳理**：定义租约、键值操作、Watch、分布式锁等方法。
2. **配置与连接池**：支持 TLS、鉴权与自定义拨号超时。
3. **租约封装**：提供心跳续约协程、失效回调。
4. **Watch 模块**：支持前缀监听、事件过滤、背压处理。
5. **锁实现**：基于 etcd 的 `Lease + CompareAndSwap`，暴露阻塞与非阻塞两种模式。
6. **DI Module**：提供 `fx` 组件注册与健康检查。

## 测试要点
- 单测：锁的互斥性、租约续约失败处理、Watch 事件正确性。
- 集成：结合本地 etcd，模拟网络抖动与租约失效。
- 观测：暴露客户端连接状态、Lease 数量、重试次数。

## 验收清单
- 出错时区分可重试与需上报的错误类型。
- 提供命名空间前缀，防止键冲突。
- 文档示例覆盖 WorkerID 分配、配置同步两大用例。

## 后续演进
- 引入 `consul` 或 `zookeeper` 的适配器以验证抽象合理性。
- 对 Watch 结果支持本地缓存加速读取。
