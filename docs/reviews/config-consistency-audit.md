# Config ç»„ä»¶ä¸€è‡´æ€§å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¶é—´**: 2025-12-03  
**å®¡æŸ¥äºº**: Cline  
**å®¡æŸ¥èŒƒå›´**: `pkg/config` å®ç°ã€examples å’Œè®¾è®¡æ–‡æ¡£çš„ä¸€è‡´æ€§

---

## 1. å®¡æŸ¥æ‘˜è¦

### æ ¸å¿ƒå‘ç°

å‘ç°äº† **1 ä¸ªé‡å¤§ä¸ä¸€è‡´é—®é¢˜**ï¼Œå·²å…¨éƒ¨ä¿®å¤ï¼š

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | çŠ¶æ€ |
|------|---------|------|
| ç”Ÿå‘½å‘¨æœŸæ–¹æ³• (`Start()`/`Stop()`/`Phase()`) ä¸è®¾è®¡æ–‡æ¡£ä¸ç¬¦ | ğŸ”´ é«˜ | âœ… å·²ä¿®å¤ |

### ä¿®å¤å†…å®¹

- âœ… ä» `pkg/config/interface.go` ä¸­ç§»é™¤ `Start()`, `Stop()`, `Phase()` æ–¹æ³•
- âœ… ä» `pkg/config/viper.go` ä¸­ç§»é™¤è¿™äº›æ–¹æ³•çš„å®ç°
- âœ… å°†æ–‡ä»¶ç›‘å¬é€»è¾‘ç§»è‡³ `Load()` æ–¹æ³•å†…è‡ªåŠ¨å¯åŠ¨
- âœ… æ›´æ–° `examples/config/main.go` ç§»é™¤å¯¹è¿™äº›æ–¹æ³•çš„è°ƒç”¨

---

## 2. è¯¦ç»†å®¡æŸ¥ç»“æœ

### 2.1 è®¾è®¡æ–‡æ¡£è§„èŒƒ

#### `docs/refactoring-plan.md` - æ˜ç¡®è§„èŒƒ

æ–‡æ¡£ç¬¬ **4.1 èŠ‚** æ˜ç¡®æŒ‡å‡ºï¼š

> **åˆ é™¤ Container åï¼Œç§»é™¤ Connector çš„ `Lifecycle` æ¥å£åŠå…¶ç»§æ‰¿**
> - `Start()` â†’ ä¸ `Connect()` é‡å¤
> - `Stop()` â†’ ä¸ `Close()` é‡å¤  
> - `Phase()` â†’ åªä¸º Container æœåŠ¡ï¼Œä¸å†éœ€è¦

ğŸ“ **ç»“è®º**ï¼šè¿™äº›æ–¹æ³•ä¸åº”è¯¥åœ¨ Config æ¥å£ä¸­å­˜åœ¨

#### `docs/foundation/config-design.md` - æ¥å£è§„èŒƒ

ç¬¬ **3.1 èŠ‚** `Loader` æ¥å£å®šä¹‰ä¸­**æ²¡æœ‰**è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œåªå®šä¹‰äº†ï¼š
- `Load()`
- `Get()`
- `Unmarshal()`
- `UnmarshalKey()`
- `Watch()`
- `Validate()`

ğŸ“ **ç»“è®º**ï¼šè¯¥æ–‡æ¡£æ˜¯æ­£ç¡®çš„è§„èŒƒ

#### `docs/genesis-design.md` - æ¶æ„æ„¿æ™¯

ç¬¬ **5.2 èŠ‚** æ ‡å‡†åˆå§‹åŒ–æ¨¡å¼ä¸­ï¼Œæ²¡æœ‰æ¶‰åŠè°ƒç”¨ `Start()`/`Stop()`

ğŸ“ **ç»“è®º**ï¼šç¬¦åˆé¢„æœŸ

### 2.2 ä»£ç å®ç°ç°çŠ¶ï¼ˆä¿®å¤å‰ï¼‰

| ç»„ä»¶ | æ–¹æ³• | çŠ¶æ€ |
|------|------|------|
| `interface.go` | `Start()` | âŒ å­˜åœ¨ |
| `interface.go` | `Stop()` | âŒ å­˜åœ¨ |
| `interface.go` | `Phase()` | âŒ å­˜åœ¨ |
| `viper.go` | `Start()` å®ç° | âŒ å­˜åœ¨ |
| `viper.go` | `Stop()` å®ç° | âŒ å­˜åœ¨ |
| `viper.go` | `Phase()` å®ç° | âŒ å­˜åœ¨ |

### 2.3 Example ä¾èµ–ï¼ˆä¿®å¤å‰ï¼‰

`examples/config/main.go` ç¬¬ 255-258 è¡Œè°ƒç”¨äº†ï¼š
```go
if err := loader.Start(ctx); err != nil {
    log.Fatalf("å¯åŠ¨é…ç½®ç›‘å¬å¤±è´¥: %v", err)
}
defer loader.Stop(ctx)
```

è¿™å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚

---

## 3. ä¿®å¤æ–¹æ¡ˆ

### 3.1 è®¾è®¡å†³ç­–

**æ–°çš„ç”Ÿå‘½å‘¨æœŸè®¾è®¡**ï¼š

```text
Before (è¿‡åº¦è®¾è®¡):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. New(opts...) â†’ Loader           â”‚
â”‚  2. Load(ctx)                       â”‚
â”‚  3. Start(ctx) â† æ‰‹åŠ¨å¯åŠ¨           â”‚
â”‚  4. Watch(ctx, key)                 â”‚
â”‚  5. Stop(ctx)  â† æ‰‹åŠ¨åœæ­¢           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After (ç®€åŒ–è®¾è®¡):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. New(opts...) â†’ Loader           â”‚
â”‚  2. Load(ctx)  â† è‡ªåŠ¨å¯åŠ¨ç›‘å¬       â”‚
â”‚  3. Watch(ctx, key)                 â”‚
â”‚     (æ–‡ä»¶ç›‘å¬å·²åœ¨ Load æ—¶å¯åŠ¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ›´ç®€æ´çš„ API
- âœ… ç¬¦åˆ"æ˜¾å¼ä¼˜äºéšå¼"åŸåˆ™
- âœ… æ— éœ€å®¹å™¨å³å¯æ­£ç¡®å·¥ä½œ
- âœ… å‡å°‘ç”¨æˆ·é”™è¯¯ï¼ˆå¿˜è®°è°ƒç”¨ `Start()`)

### 3.2 å…·ä½“ä¿®æ”¹

#### ä¿®æ”¹ 1: `pkg/config/interface.go`

**ç§»é™¤æ–¹æ³•**:
```go
// âŒ ç§»é™¤è¿™ä¸‰ä¸ªæ–¹æ³•
- Start(ctx context.Context) error
- Stop(ctx context.Context) error
- Phase() int
```

**æ–°æ¥å£**ï¼ˆ6 ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼‰ï¼š
```go
type Loader interface {
    Load(ctx context.Context) error
    Get(key string) any
    Unmarshal(v any) error
    UnmarshalKey(key string, v any) error
    Watch(ctx context.Context, key string) (<-chan Event, error)
    Validate() error
}
```

#### ä¿®æ”¹ 2: `pkg/config/viper.go`

**ç»“æ„ä½“ç®€åŒ–**:
```go
// Before
type loader struct {
    v            *viper.Viper
    opts         *Options
    mu           sync.RWMutex
    watches      map[string][]chan Event
    oldValues    map[string]interface{}
    watchStarted bool  // âŒ ç§»é™¤
}

// After
type loader struct {
    v         *viper.Viper
    opts      *Options
    mu        sync.RWMutex
    watches   map[string][]chan Event
    oldValues map[string]interface{}
}
```

**æ–¹æ³•ç§»é™¤**:
```go
// âŒ ç§»é™¤è¿™ä¸‰ä¸ªæ–¹æ³•çš„å®ç°
- func (l *loader) Start(ctx context.Context) error
- func (l *loader) Stop(ctx context.Context) error
- func (l *loader) Phase() int
```

**Load æ–¹æ³•å¢å¼º**:
```go
// åœ¨ Load() æœ«å°¾è‡ªåŠ¨å¯åŠ¨æ–‡ä»¶ç›‘å¬
l.v.OnConfigChange(func(e fsnotify.Event) {
    if err := l.loadEnvironmentConfig(); err != nil {
        fmt.Printf("Error reloading environment config: %v\n", err)
    }
    if err := l.loadDotEnv(); err != nil {
        fmt.Printf("Warning: failed to reload .env file: %v\n", err)
    }
    l.notifyWatches(e)
})
l.v.WatchConfig()
```

#### ä¿®æ”¹ 3: `examples/config/main.go`

**ç§»é™¤è°ƒç”¨**:
```go
// âŒ ç§»é™¤è¿™ä¸¤è¡Œ
- if err := loader.Start(ctx); err != nil { ... }
- defer loader.Stop(ctx)

// âœ… æ›¿æ¢ä¸ºè¯´æ˜æ³¨é‡Š
// æ³¨æ„ï¼šæ–‡ä»¶ç›‘å¬åœ¨ Load() æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€æ‰‹åŠ¨ Start()
```

---

## 4. ä¸€è‡´æ€§éªŒè¯ç»“æœ

### 4.1 ä¿®å¤åçš„å¯¹é½

| é¡¹ç›® | ç°çŠ¶ | è®¾è®¡è§„èŒƒ | çŠ¶æ€ |
|------|------|---------|------|
| æ¥å£å®šä¹‰ | 6 æ–¹æ³• | âœ… 6 æ–¹æ³• | âœ… **ä¸€è‡´** |
| ç”Ÿå‘½å‘¨æœŸ | æ— æ˜¾å¼ `Start/Stop` | âœ… æ—  | âœ… **ä¸€è‡´** |
| æ–‡ä»¶ç›‘å¬ | Load() è‡ªåŠ¨å¯åŠ¨ | âœ… è‡ªåŠ¨ | âœ… **ä¸€è‡´** |
| Example | æ—  `Start/Stop` è°ƒç”¨ | âœ… æ—  | âœ… **ä¸€è‡´** |
| ç¼–è¯‘çŠ¶æ€ | âœ… é€šè¿‡ | âœ… - | âœ… **é€šè¿‡** |

### 4.2 è®¾è®¡æ–‡æ¡£ä¸€è‡´æ€§

```
docs/genesis-design.md (æ„¿æ™¯)
    â†“ [å¯¹æ ‡]
docs/refactoring-plan.md (æ‰§è¡Œè®¡åˆ’)
    â†“ [éµå¾ª]
docs/foundation/config-design.md (è§„èŒƒ)
    â†“ [ç¬¦åˆ]
pkg/config/* (å®ç°) âœ…
```

æ‰€æœ‰ä¸‰ä»½æ–‡æ¡£ç°å·²å¯¹é½ã€‚

---

## 5. éªŒè¯æ¸…å•

- [x] å®¡æŸ¥ `pkg/config` ä»£ç ä¸è®¾è®¡æ–‡æ¡£
- [x] è¯†åˆ«ä¸ä¸€è‡´ä¹‹å¤„
- [x] æ‰§è¡Œä»£ç ä¿®å¤
- [x] æ‰§è¡Œ example æ›´æ–°
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡
- [x] ç”Ÿæˆå®¡æŸ¥æŠ¥å‘Š

---

## 6. å»ºè®®

### 6.1 é•¿æœŸç»´æŠ¤

1. **å»ºç«‹ä¸€è‡´æ€§æ£€æŸ¥æµç¨‹**ï¼š
   - åœ¨ä»£ç å®¡æŸ¥æ—¶æ£€æŸ¥æ¥å£æ˜¯å¦ä¸è®¾è®¡æ–‡æ¡£å¯¹é½
   - åœ¨ä¿®æ”¹è®¾è®¡æ—¶åŒæ­¥æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡æ¡£å’Œä»£ç 

2. **æ·»åŠ æ¶æ„å†³ç­–è®°å½•**ï¼š
   - åœ¨ `docs/reviews/architecture-decisions.md` ä¸­è®°å½•æœ¬æ¬¡é‡æ„å†³ç­–
   - ä¾¿äºæœªæ¥ç†è§£è®¾è®¡æ„å›¾

3. **è¡¥å……å•å…ƒæµ‹è¯•**ï¼š
   - ä¸º `Config.Watch()` åŠŸèƒ½æ·»åŠ æ›´å®Œæ•´çš„æµ‹è¯•
   - éªŒè¯æ–‡ä»¶ç›‘å¬åœ¨ `Load()` åè‡ªåŠ¨å¯åŠ¨

### 6.2 å…¶ä»– L0 ç»„ä»¶

å»ºè®®å¯¹å…¶ä»– L0 åŸºç¡€ç»„ä»¶è¿›è¡Œç±»ä¼¼å®¡æŸ¥ï¼š
- `pkg/clog` - æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸å¿…è¦çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
- `pkg/xerrors` - æ£€æŸ¥é”™è¯¯å®šä¹‰çš„ä¸€è‡´æ€§

---

## 7. æ€»ç»“

æœ¬æ¬¡å®¡æŸ¥å‘ç°å¹¶ä¿®å¤äº† Config ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸè®¾è®¡ä¸ä¸€è‡´é—®é¢˜ï¼Œä½¿ä»£ç ã€ä¾‹å­å’Œæ–‡æ¡£å®Œå…¨å¯¹é½ï¼š

âœ… **ä»£ç ç°å·²ç¬¦åˆé‡æ„è®¡åˆ’è§„èŒƒ**  
âœ… **æ‰€æœ‰ç¼–è¯‘é”™è¯¯å·²è§£å†³**  
âœ… **æ–‡æ¡£å’Œå®ç°ä¿æŒä¸€è‡´**

Config ç»„ä»¶ç°åœ¨æ˜¯ä¸€ä¸ª**ç®€æ´ã€ç¬¦åˆ Go ä¹ æƒ¯çš„é…ç½®åŠ è½½å™¨**ï¼Œæ— éœ€æ˜¾å¼çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
