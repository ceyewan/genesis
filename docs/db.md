# DB 组件实施手册

## 功能边界
- 提供数据库连接管理、事务封装、读写分离扩展位。
- 默认使用 GORM，同时保持接口足够瘦，便于替换。
- 支持链路追踪与慢查询告警。

## 代码位置
- 接口：`pkg/db/db.go`
- 配置：`pkg/db/config.go`
- 默认实现：`internal/db/gorm`

## 开发步骤
1. **接口设计**：定义 `DB`、`Tx`、`Transaction` 等接口，关注上下文透传与超时。
2. **配置结构**：数据库地址、连接池、超时、慢查询阈值、读写标签。
3. **GORM 包装**：
   - 初始化 `gorm.DB`，注入日志与指标。
   - 提供 `WithTx(ctx, fn)` 简化事务处理。
4. **迁移与种子脚本**：在 `internal/db/migrate` 中放置示例迁移工具。
5. **DI Module**：支持多数据源注册，通过标签区分用途。

## 测试要点
- 单测：事务回滚、超时取消、连接池参数应用。
- 集成：使用 docker-compose 启动 MySQL/PostgreSQL，执行 CRUD 验证。
- 性能：简单基准评估批量插入与查询。

## 验收清单
- 慢查询日志包含 SQL、耗时、trace_id。
- 事务函数确保 panic 时自动回滚并返回错误。
- 提供连接健康检查，`usage_guide.md` 有示例。

## 后续演进
- 支持 read replica，提供一致性策略选项。
- 与缓存组件协同，形成二级缓存插件。
